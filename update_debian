#!/usr/bin/env bash

set -euo pipefail  # Exit on error, undefined vars, pipe failures

declare -i CLEANUP_FLAG=1
declare -i SSH_PORT=22

_prt_init_msg() {
  CLEANUP_FLAG=1
  local msg="${1:-"This is a message."}"
  echo "$msg"
}

_prt_cleared_msg() {
  CLEANUP_FLAG=0
  local msg="${1:-"This is a message."}"
  echo "$msg"
}

_prt_error() {
  local msg="${1:-"Unknown error."}"
  echo "$msg" && exit 1
}

_confirm() {
  local prompt="$1 [y/n]: "
  local response

  while true; do
    printf "%s" "$prompt"
    read -r response
    response=${response,,}

    case $response in
      y | yes) return 0 ;;
      n | no) return 1 ;;
      *) ;;
    esac
  done
}

_fetch_ssh_port() {
  SSH_PORT=$(( $(lsof -nP -iTCP -sTCP:LISTEN | grep -m 1 sshd | cut -d ':' -f 2 | cut -d ' ' -f 1) ))
}

_validate_ssh_port() {
  [[ "$1" =~ ^[0-9]+$ && "$1" -ge 1024 && "$1" -le 65535 ]]
}

_update_system() {
  _prt_init_msg "Updating system packages..."
  if [ ! -f "/etc/apt/sources.list.d/debian.sources" ]; then
    sed -i -e 's/^\(deb.*\)/# \1/' /etc/apt/sources.list
    tee /etc/apt/sources.list.d/debian.sources > /dev/null << EOF
Types: deb deb-src
URIs: https://deb.debian.org/debian
Suites: trixie trixie-updates
## If you want access to contrib and non-free components,
## add " contrib non-free" after "non-free-firmware":
Components: main non-free-firmware
Enabled: yes
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

Types: deb deb-src
URIs: https://security.debian.org/debian-security
Suites: trixie-security
Components: main non-free-firmware
Enabled: yes
Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg
EOF
  fi
  if ! apt-get update && apt-get upgrade -y -qq --no-install-recommends; then
    _prt_error "Failed to update system packages."
  fi
}

CORE_PKG=(
  ca-certificates
  coreutils
  sudo
  curl
  wget
  rsync
  vim
  jq
  tree
  perl
  gawk
  file
  zip
  unzip
  make
  gcc
  ssh
  git
  xz-utils
  openssh-client
  openssh-server
  xdg-user-dirs
  cron
  chrony
  htop
  iotop
  skopeo
  lsof
)

_install_core_pkg() {
  _prt_init_msg "Installing core packages..."
  if ! apt-get install -y -qq --no-install-recommends "${CORE_PKG[@]}"; then
    _prt_error "Failed to install one or more packages."
  else
    _prt_cleared_msg "Installing core packages completed."
  fi
}

_update_timezone() {
  _prt_init_msg "Updating to local timezone..."
  local msg
  if [[ "$(timedatectl | grep -o "Europe/Stockholm")" == *Europe/Stockholm* ]]; then
    msg="Local timezone already updated."
  else
    if [ "$LANG" == "C" ]; then
      dpkg-reconfigure tzdata
    else
      sed -i -e 's/Europe/Stockholm/' /etc/timezone &&
        DEBIAN_FRONTEND=noninteractive dpkg-reconfigure --frontend=noninteractive tzdata
    fi
    msg="Updating timezone completed."
  fi
  _prt_cleared_msg "$msg"
}

_update_locale() {
  _prt_init_msg "Updating locales..."

  local msg
  if ! apt-get install -y -qq --no-install-recommends locales; then
    _prt_error "Failed to install locales package."
  fi

  local _nolang=0
  if ! printenv | grep -q "LANG="; then _nolang=1; fi

  if [ "$_nolang" -eq 1 ] || [[ "$LANG" != "en_US.UTF-8" ]]; then
    sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen &&
      DEBIAN_FRONTEND=noninteractive dpkg-reconfigure --frontend=noninteractive locales &&
      update-locale LANG=en_US.UTF-8
    msg="Updating locales completed."

  elif [ "$LANG" == "en_US.UTF-8" ]; then
    msg="Locale already set to en_US.UTF-8."
  fi
  _prt_cleared_msg "$msg"
}

HARDENING_PKG=(
  ufw
  fail2ban
  unattended-upgrades
  nethogs
  netcat-traditional
  ncdu
)

_install_hardening_pkg() {
  _prt_init_msg "Installing hardening packages..."
  if ! apt-get install -y -qq --no-install-recommends "${HARDENING_PKG[@]}"; then
    _prt_error "Failed to install one or more essential packages."
  else
    _prt_cleared_msg "Installing hardening packages completed."
  fi
}

_setup_ssh_hardening() {
  _prt_init_msg "Hardening SSH configuration..."

  if ! dpkg -l openssh-server | grep -q ^ii; then
    local _ufw_warning_msg="openssh-server package is not installed. Install it?"
    if _confirm "$_ufw_warning_msg"; then
      if ! apt-get install -y -qq --no-install-recommends openssh-server; then
        _prt_error "Failed to install the openssh-server package."
      fi
    else return 0; fi
  fi

  while [ $SSH_PORT -eq 22 ]; do
    printf "Enter custom SSH port (1024-65535): "
    read -r SSH_PORT
    SSH_PORT=${SSH_PORT:-22}

    if _validate_ssh_port "$SSH_PORT"; then break
    else echo "Invalid port number."; fi
  done

  [ -d "/etc/ssh/sshd_config.d" ] || mkdir -p /etc/ssh/sshd_config.d
  tee /etc/ssh/sshd_config.d/99-hardening.conf > /dev/null << EOF
Port $SSH_PORT
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
MaxAuthTries 3
ClientAliveInterval 300
X11Forwarding no
PrintMotd no
Banner /etc/issue.net
EOF

  tee /etc/issue.net > /dev/null << EOF

 * All attempts are logged and reviewed

EOF

  echo "Reloading systemd and restarting SSH service..."
  systemctl daemon-reload
  systemctl restart sshd.service
  sleep 5

  _fetch_ssh_port
  printf "Verifying root SSH login is disabled... "
  if [ $SSH_PORT -eq 22 ]; then
    : "Root SSH login is still possible! Check configuration."
  else
    : "Completed: Root SSH login is disabled."
  fi
  _prt_cleared_msg "$_"
}

_setup_firewall() {
  _prt_init_msg "Configuring UFW firewall..."

  if ! dpkg -l ufw | grep -q ^ii; then
    local _ufw_warning_msg="UFW package is not installed. Install the hardening packages?"
    if _confirm "$_ufw_warning_msg"; then _install_hardening_pkg; else return 0; fi
  fi

  if ufw status | grep -q "Status: active"; then
    echo "UFW is already enabled."
  else
    echo "Configuring UFW default policies..."
    ufw default deny incoming
    ufw default allow outgoing
  fi

  _fetch_ssh_port
  if [ "$SSH_PORT" -eq 22 ]; then
    local _ssh_warning_msg="SSH port is setup to default (22/tcp). Set up SSH hardening?"
    if _confirm "$_ssh_warning_msg"; then _configure_ssh; fi
  fi

  if ! ufw status | grep -qw "$SSH_PORT/tcp"; then
    echo "Adding SSH rule for port $SSH_PORT..."
    ufw allow "$SSH_PORT"/tcp comment 'SSH'
  else
    echo "SSH rule for port $SSH_PORT already exists."
  fi

  if ! ufw status | grep -qw "80/tcp"; then
    ufw allow http comment 'HTTP'
    echo "HTTP traffic allowed."
  else
    echo "HTTP rule already exists."
  fi

  if ! ufw status | grep -qw "443/tcp"; then
    ufw allow https comment 'HTTPS'
    echo "HTTPS traffic allowed."
  else
    echo "HTTPS rule already exists."
  fi

  echo "Enabling firewall..."
  if ! ufw --force enable; then
    _prt_error "Failed to enable UFW: Check 'journalctl -u ufw' for details."
  fi

  if ufw status | grep -q "Status: active"; then
    _prt_cleared_msg "Completed: Firewall is active."
  else
    _prt_error "UFW failed to activate: Check 'journalctl -u ufw' for details."
  fi
}

_setup_fail2ban() {
  _prt_init_msg "Configuring Fail2Ban..."

  if ! dpkg -l fail2ban | grep -q ^ii; then
    local _ufw_warning_msg="UFW package is not installed. Install the hardening packages?"
    if _confirm "$_ufw_warning_msg"; then _install_hardening_pkg; else return 0; fi
  fi

  local UFW_PROBES_CONFIG
  UFW_PROBES_CONFIG=$(cat << EOF
[Definition]
# This regex looks for the standard "[UFW BLOCK]" message in /var/log/ufw.log
failregex = \[UFW BLOCK\] IN=.* OUT=.* SRC=<HOST>
ignoreregex =
EOF
  )

  _fetch_ssh_port
  if [ "$SSH_PORT" -eq 22 ]; then
    local _ssh_warning_msg="SSH port is setup to default (22/tcp). Would you like to harden the SSH config?"
    if _confirm "$_ssh_warning_msg"; then _configure_ssh; fi
  fi

  local JAIL_LOCAL_CONFIG
  JAIL_LOCAL_CONFIG=$(cat << EOF
[DEFAULT]
ignoreip = 127.0.0.1/8 ::1
bantime = -1
findtime = 10m
maxretry = 3
banaction = ufw

[sshd]
enabled = true
port = $SSH_PORT

# This jail monitors UFW logs for rejected packets (port scans, etc.).
[ufw-probes]
enabled = true
port = all
filter = ufw-probes
logpath = /var/log/ufw.log
EOF
  )

  UFW_FILTER_PATH="/etc/fail2ban/filter.d/ufw-probes.conf"
  JAIL_LOCAL_PATH="/etc/fail2ban/jail.local"

  # This checks if the on-disk files are already identical to our desired configuration.
  if [[ -f "$UFW_FILTER_PATH" && -f "$JAIL_LOCAL_PATH" ]] &&
    cmp -s "$UFW_FILTER_PATH" <<< "$UFW_PROBES_CONFIG" &&
    cmp -s "$JAIL_LOCAL_PATH" <<< "$JAIL_LOCAL_CONFIG"; then
    _prt_cleared_msg "Fail2Ban is already configured correctly."
    return 0
  fi

  # If the check above fails, we write the correct configuration files.
  echo "Applying new Fail2Ban configuration..."

  [ -d "/etc/fail2ban/filter.d" ] || mkdir -p /etc/fail2ban/filter.d
  echo "$UFW_PROBES_CONFIG" > "$UFW_FILTER_PATH"
  echo "$JAIL_LOCAL_CONFIG" > "$JAIL_LOCAL_PATH"

  # --- Ensure the log file exists BEFORE restarting the service ---
  if [ ! -f "/var/log/ufw.log" ]; then
    touch /var/log/ufw.log
    echo "Created empty /var/log/ufw.log to ensure Fail2Ban starts correctly."
  fi

  # --- Restart and Verify Fail2ban ---
  echo "Enabling and restarting Fail2Ban to apply new rules..."
  systemctl enable fail2ban
  systemctl restart fail2ban
  sleep 2

  if systemctl is-active --quiet fail2ban; then
    fail2ban-client status | tee -a /var/log/ufw.log
    : "Completed: Fail2Ban is active with the new configuration."
  else
    : "Fail2Ban service failed to start: Check 'journalctl -u fail2ban' for errors."
  fi
  _prt_cleared_msg "$_"
}

_setup_autoupdates() {
  _prt_init_msg "Configuring unattended upgrades..."
  if ! dpkg -l unattended-upgrades | grep -q ^ii; then
    _prt_error "unattended-upgrades package is not installed."
  fi

  # Check for existing unattended-upgrades configuration
  if [ -f "/etc/apt/apt.conf.d/50unattended-upgrades" ] &&
    grep -q "Unattended-Upgrade::Allowed-Origins" /etc/apt/apt.conf.d/50unattended-upgrades; then
      echo "Existing unattended-upgrades configuration found."
      : "Verify with 'cat /etc/apt/apt.conf.d/50-unattended-upgrades'."
  else
    echo "unattended-upgrades unattended-upgrades/enable_auto_updates boolean true" | debconf-set-selections
    if DEBIAN_FRONTEND=noninteractive dpkg-reconfigure -f noninteractive unattended-upgrades; then
      : "Completed: Automatic security updates enabled."
    else
      : "Files created but couldn't set up unattended upgrades."
    fi
  fi
  _prt_cleared_msg "$_"
}

_setup_kernel_hardening() {
  _prt_init_msg "Setting up Kernel Parameter Hardening (sysctl)..."

  local KERNEL_HARDENING_CONFIG
  KERNEL_HARDENING_CONFIG=$(mktemp)
  tee "$KERNEL_HARDENING_CONFIG" > /dev/null << EOF
# Recommended Security Settings
# For details, see: https://www.kernel.org/doc/Documentation/sysctl/

# --- IPV4 Networking ---
# Protect against IP spoofing
net.ipv4.conf.default.rp_filter=1
net.ipv4.conf.all.rp_filter=1
# Block SYN-FLOOD attacks
net.ipv4.tcp_syncookies=1
# Ignore ICMP redirects
net.ipv4.conf.all.accept_redirects=0
net.ipv4.conf.default.accept_redirects=0
net.ipv4.conf.all.secure_redirects=1
net.ipv4.conf.default.secure_redirects=1
# Ignore source-routed packets
net.ipv4.conf.all.accept_source_route=0
net.ipv4.conf.default.accept_source_route=0
# Log martian packets (packets with impossible source addresses)
net.ipv4.conf.all.log_martians=1
net.ipv4.conf.default.log_martians=1

# --- IPV6 Networking (if enabled) ---
net.ipv6.conf.all.accept_redirects=0
net.ipv6.conf.default.accept_redirects=0
net.ipv6.conf.all.accept_source_route=0
net.ipv6.conf.default.accept_source_route=0

# --- Kernel Security ---
# Enable ASLR (Address Space Layout Randomization) for better security
kernel.randomize_va_space=2
# Restrict access to kernel pointers in /proc to prevent leaks
kernel.kptr_restrict=2
# Restrict access to dmesg for unprivileged users
kernel.dmesg_restrict=1
# Restrict ptrace scope to prevent process injection attacks
kernel.yama.ptrace_scope=1

# --- Filesystem Security ---
# Protect against TOCTOU (Time-of-Check to Time-of-Use) race conditions
fs.protected_hardlinks=1
fs.protected_symlinks=1
EOF

  local SYSCTL_CONF_FILE="/etc/sysctl.d/99-du-hardening.conf"

  # only update if the file doesn't exist or has changed
  if [ -f "$SYSCTL_CONF_FILE" ] && cmp -s "$KERNEL_HARDENING_CONFIG" "$SYSCTL_CONF_FILE"; then
    _prt_cleared_msg "Kernel security settings are already configured correctly."
    rm -f "$KERNEL_HARDENING_CONFIG"
    return 0
  fi

  echo "Applying settings to $SYSCTL_CONF_FILE..."
  mv "$KERNEL_HARDENING_CONFIG" "$SYSCTL_CONF_FILE"
  chmod 644 "$SYSCTL_CONF_FILE"
  if sysctl -p "$SYSCTL_CONF_FILE" > /dev/null 2>&1; then
    : "Completed: Kernel security settings applied successfully."
  else
    : "Failed to apply kernel settings: Check for kernel compatibility."
  fi
  _prt_cleared_msg "$_"
}

_setup_timesync() {
  _prt_init_msg "Ensuring chrony is active..."

  if ! dpkg -l chrony | grep -q ^ii; then
    local _ufw_warning_msg="Chrony package is not installed. Install it?"
    if _confirm "$_ufw_warning_msg"; then 
      if ! apt-get install -y -qq --no-install-recommends chrony; then
        _prt_error "Failed to install the chrony package."
      fi
    else return 0; fi
  fi

  systemctl enable --now chrony
  sleep 2

  if systemctl is-active --quiet chrony; then
    _prt_cleared_msg "Chrony is active for time synchronization."
  else
    _prt_error "Chrony service failed to start."
  fi
}

DOCKER_PKG_REMOVE=(
  docker
  docker-engine
  docker.io
  docker-ce
  docker-ce-cli
  containerd
  containerd.io
  docker-buildx-plugin
  docker-compose-plugin
  docker-compose
  docker-doc
  podman-docker
  runc
)

DOCKER_PKG=(
  docker-ce
  docker-ce-cli
  containerd.io
  docker-buildx-plugin
  docker-compose-plugin
)

# https://docs.docker.com/engine/install/debian/
_setup_docker_engine() {
  _prt_init_msg "Setting up docker engine..."

  if systemctl is-active --quiet docker; then
    _prt_cleared_msg "Docker already installed and running."
    return 0
  fi

  echo "Removing old docker packages..."
  apt-get remove -y -qq "${DOCKER_PKG_REMOVE[@]}" 2> /dev/null || true

  _update_system
  if ! apt-get install -y -qq --no-install-recommends ca-certificates curl; then
    _prt_error "Failed to install one or more packages."
  fi

  install -m 0755 -d /etc/apt/keyrings
  echo "Adding Docker's official GPG key and repository..."
  curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
  chmod a+r /etc/apt/keyrings/docker.asc

  # Add the repository to Apt sources:
  if [ ! -f "/etc/apt/sources.list.d/docker.sources" ]; then
    echo "Adding Docker sources to /etc/apt/sources.list.d/..."
    tee /etc/apt/sources.list.d/docker.sources > /dev/null << EOF
Types: deb
URIs: https://download.docker.com/linux/debian
Suites: $VERSION_CODENAME
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF
  fi

  _update_system
  echo "Installing Docker packages..."
  if ! apt-get install -y -qq "${DOCKER_PKG[@]}"; then
    _prt_error "Failed to install one or more docker packages."
  fi

  local NEW_DOCKER_CONFIG
  NEW_DOCKER_CONFIG=$(mktemp)
  tee "$NEW_DOCKER_CONFIG" > /dev/null << EOF
{
  "log-driver": "json-file",
  "log-opts": { "max-size": "10m", "max-file": "3" },
  "live-restore": true
}
EOF

  [ -d "/etc/docker" ] || mkdir -p /etc/docker
  if [ -f "/etc/docker/daemon.json" ] && cmp -s "$NEW_DOCKER_CONFIG" /etc/docker/daemon.json; then
    echo "Docker daemon already configured."
    rm -f "$NEW_DOCKER_CONFIG"
  else
    echo "Configuring Docker daemon..."
    mv "$NEW_DOCKER_CONFIG" /etc/docker/daemon.json
    chmod 644 /etc/docker/daemon.json
  fi

  systemctl daemon-reload
  systemctl enable --now docker

  getent group docker > /dev/null || groupadd docker
  if ! groups "$SUDO_USER" | grep -qw docker; then
    printf "%s " "Adding '$SUDO_USER' to docker group..."
    usermod -aG docker "$SUDO_USER" && echo "Done."
  else
    echo "User '$SUDO_USER' is already in docker group."
  fi
  _prt_cleared_msg "Completed: Docker engine up and running."
}

_cleanup() {
  echo "Running system update and cleanup..."

  if ! apt-get update -y -qq; then
    echo "Updating package lists failed during final cleanup."
    return 1
  fi

  if ! apt-get --purge autoremove -y -qq ||
     ! apt-get autoclean -y -qq ||
     ! apt-get clean -y -qq; then
    echo "System cleanup failed on one or more commands."
    return 1
  fi
  rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

  if systemctl daemon-reload; then
    echo "Reload of systemd daemons completed."
    echo "Success: Final system update and cleanup complete."
  fi
}

_run() {
  if [ "$(id -u)" -ne 0 ]; then # root check
    echo "Error: This script must be run with root privileges."
    _prt_error "Re-run the script using 'sudo -E'"
  fi

  . /etc/os-release
  printf "++\n%s\n++\n" "Starting Debian '$VERSION_CODENAME' hardening script..."

  local run_all="Run the complete installation sequentially?"
  if _confirm "$run_all"; then
    while [ $SSH_PORT -eq 22 ]; do
      printf "Enter custom SSH port (1024-65535): "
      read -r SSH_PORT
      SSH_PORT=${SSH_PORT:-22}
      if _validate_ssh_port "$SSH_PORT"; then break
      else echo "Invalid port number."; fi
    done
    _update_system
    _install_core_pkg
    _update_timezone
    _update_locale
    _install_hardening_pkg
    _setup_ssh_hardening
    _setup_firewall
    _setup_fail2ban
    _setup_autoupdates
    _setup_kernel_hardening
    _setup_timesync
    _setup_docker_engine
    _cleanup
    return 0
  fi

  local update_system="Update system packages?"
  if _confirm "$update_system"; then _update_system; fi

  local packages_core="Install core packages?"
  if _confirm "$packages_core"; then _install_core_pkg; fi

  local update_timezone="Update timezone to Europe/Stockholm?"
  if _confirm "$update_timezone"; then _update_timezone; fi

  local update_locale="Update locale to US-UTF-8?"
  if _confirm "$update_locale"; then _update_locale; fi

  local packages_hardening="Install net & hardening packages?"
  if _confirm "$packages_hardening"; then _install_hardening_pkg; fi

  local hardening_ssh="Harden the SSH config?"
  if _confirm "$hardening_ssh"; then _setup_ssh_hardening;  fi

  local setup_ufw="Install and configure UFW firewall?"
  if _confirm "$setup_ufw"; then _setup_firewall;  fi

  local setup_fail2ban="Install and configure fail2ban?"
  if _confirm "$setup_fail2ban"; then _setup_fail2ban;  fi

  local setup_autoupdates="Set up automatic updates?"
  if _confirm "$setup_autoupdates"; then _setup_autoupdates;  fi

  local hardening_kernel="Set up kernel hardening?"
  if _confirm "$hardening_kernel"; then _setup_kernel_hardening;  fi

  local setup_timesync="Set up chrony for time synchronization?"
  if _confirm "$setup_timesync"; then _setup_timesync;  fi

  local setup_docker="Install docker?"
  if _confirm "$setup_docker"; then _setup_docker_engine;  fi

  if [ "$CLEANUP_FLAG" -eq 0 ]; then _cleanup; fi
}

if [ "${#BASH_SOURCE[@]}" -eq 1 ]; then
  _run "$@"
fi

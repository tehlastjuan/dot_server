#!/usr/bin/env bash

# cd to current dir on lf quit
r() {
  export LF_CD_FILE=/var/tmp/.lfcd-$$
  command lf "${@}"
  if [ -s "$LF_CD_FILE" ]; then
    local DIR
    DIR="$(realpath "$(cat "$LF_CD_FILE")")"
    if [ "$DIR" != "$PWD" ]; then
      cd "$DIR" || exit
    fi
    rm "$LF_CD_FILE"
  fi
  unset LF_CD_FILE
}

# fzf file opener
f() {
  local file
  file=$(fzf --query="$1" --select-1 --exit-0 --preview="$XDG_CONFIG_HOME/lf/preview {}")
  if [ -n "$file" ]; then
    case $(file --dereference --mime-type "$file" -b) in
      application/json) $EDITOR "$file" ;;
      text/*)           $EDITOR "$file" ;;
      *)                return 1 ;;
    esac
  fi
}

# note ./here
nh() {
  case "${1-}" in
    -u|--unix) shift; $EDITOR "${1:-"note"}-$(date +%s).md" ;;
    *) $EDITOR "${1:-"note"}-$(date +%Y%m%d-%H%M%S).md" ;;
  esac
}

jctl() {
  local -i cols
  local -i width
  cols=$(tput cols)
  width=$(if [ $cols -lt 121 ]; then echo 113; else echo $((cols - 4));   fi)
  journalctl "$@" |
    bat --style=plain --language=log --wrap=character --terminal-width=$width
}

# pretty-print journalctl with sudo
sjctl() {
  local -i cols
  local -i width
  cols=$(tput cols)
  width=$(if [ $cols -lt 121 ]; then echo 113; else echo $((cols - 4));   fi)
  sudo journalctl "$@" |
    bat --style=plain --language=log --wrap=character --terminal-width=$width
}

# SHA256 file check
chsum() {
  local checksum=
  local filename=

  __prt_info() {
    cat << EOT
usage: chsum [ARGS]
       chsum [FILE]              := read file l1 with "SHA256SUM  FILENAME"
       chsum [STRING]            := read string "SHA256SUM  FILENAME"
       chsum [SUM] [FILENAME]    := read string "SHA256SUM", read string "FILENAME"
EOT
    }

  if [ -f "${1-}" ]; then
    local line; line=$(cat "$1" | head -1)
    checksum=${line%  *}
    filename=${line##*  }
  elif [ $# -eq 1 ]; then
    checksum=${1%  *}
    filename=${1##*  }
  elif [ $# -eq 2 ]; then
    checksum=${1}
    filename=${2}
  else
    __prt_info && return 1
  fi

  if [[ "$(sha256sum "$filename")" == "$checksum  $filename" ]]; then
    echo "Checksum OK" >&2 && return
  fi
  echo "Checksum failed" >&2 && false
}

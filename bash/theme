#!/usr/bin/env bash

if [ -z "$(LC_ALL=C type -t __git_ps1)" ]; then
	__git_ps1() {
		echo ''
	}
fi

if [[ "$OSTYPE" == linux-gnu* ]]; then
  # Load directory and file colors for GNU ls
  if [ -f "$XDG_CONFIG_HOME/bash/dircolors" ]; then
    eval "$(dircolors -b "$XDG_CONFIG_HOME/bash/dircolors")"
  else
    eval "$(dircolors)"
  fi
fi

# better debug info for set -x
# shellcheck disable=2016
build_ps4() {
  local proc_status='$(if [ "$?" -eq 0 ]; then echo "\033[32m"; else echo "\033[31m"; fi)'
  local line_num='$(printf "%4u" "$LINENO")\033[0m'
  local source_script='${BASH_SOURCE[0]##*/}/${FUNCNAME[0]:-''}'
  echo -e "${proc_status}${line_num} ${source_script}\t"
}

export PS4
PS4=$(build_ps4)

# shellcheck disable=2016
build_ps1() {
  local domain_name='\u@\h'
  local hostname=
	if [ -f "/etc/resolv.conf" ]; then
		hostname="$(cat /etc/resolv.conf | grep 'search' | grep -v '^#' | cut -d ' ' -f 2)"
	elif [ -f "/etc/hosts" ]; then
		hostname="$(cat /etc/hosts | grep "$HOSTNAME" | cut -f 2)"
	fi
  [ -n "$hostname" ] && domain_name+=".${hostname}"

  local dir_name='\[\033[01;32m\]\W'
  local git_branch='\[\033[01;36m\]$(__git_ps1 " %s")'
  local prompt='\[\033[01;32m\] \$\[\033[00m\] '

  if [ -n "$SSH_TTY" ] || [ -e "/.dockerenv" ]; then
    PS1="\[\033[01;33m\]${domain_name} ${dir_name}${git_branch}${prompt}"
  elif [ "$(id -u)" -eq 0 ]; then
    PS1="\[\033[01;31m\]${domain_name} ${dir_name}${git_branch}${prompt}"
  else
    PS1="${dir_name}${git_branch}${prompt}"
  fi
}

build_ps1
